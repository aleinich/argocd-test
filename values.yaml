common_storage: &storage_size "5Gi"

common_probes: &probe_config
  livenessProbe:
    initialDelaySeconds: 30
    periodSeconds: 15
  readinessProbe:
    initialDelaySeconds: 30
    periodSeconds: 15

node1:
  fullnameOverride: "vm-node1"
  server:
    annotations: 
      argocd.argoproj.io/sync-wave: "1"
    persistentVolume: { enabled: true, size: *storage_size }
    <<: *probe_config
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/instance
              operator: In
              values: ["vm-node1", "vm-node2"]
          topologyKey: "kubernetes.io/hostname"
  vmagent: { enabled: false }

node2:
  fullnameOverride: "vm-node2"
  server:
    annotations: 
      argocd.argoproj.io/sync-wave: "2"
    persistentVolume: { enabled: true, size: *storage_size }
    <<: *probe_config
    affinity:
      podAntiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution:
        - labelSelector:
            matchExpressions:
            - key: app.kubernetes.io/instance
              operator: In
              values: ["vm-node1", "vm-node2"]
          topologyKey: "kubernetes.io/hostname"
  vmagent: { enabled: false }

vmauth:
  enabled: true
  fullnameOverride: "vm-gateway"
  replicaCount: 2
  
  # Nel chart 0.23.0 la chiave per il deployment è 'deploymentStrategy'
  # o viene iniettata tramite 'extraArgs'. Tuttavia, molti utenti hanno risolto così:
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
      maxSurge: 1

  # Se il chart ignora 'strategy', forziamo la sovrascrittura tramite patch nel modulo Terraform o ArgoCD
  # Ma prima, assicuriamoci che le probes siano correttamente indentate:
  livenessProbe:
    tcpSocket:
      port: 8427
    initialDelaySeconds: 10
  readinessProbe:
    tcpSocket:
      port: 8427
    initialDelaySeconds: 10

  config:
    unauthorized_user:
      url_prefix: 
        - "http://vm-node1-server:8428"
        - "http://vm-node2-server:8428"
